/*************************************************
 * Day10 ‚Äì ‡∏Ñ‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á (search_every_slot.gs)
 * step ‡πÄ‡∏ß‡∏•‡∏≤ = 60 ‡∏ô‡∏≤‡∏ó‡∏µ
 *************************************************/

// ====== CONFIG ======
const SEARCH_OPEN_TIME = '16:00';
const SEARCH_CLOSE_TIME = '24:00';
const SEARCH_STEP_MIN = 60;
const ADMIN_PHONE = '0839144000'; // ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏à‡∏£‡∏¥‡∏á

function getFieldType_(fieldId) {
  return getFieldTypeFromRegistry_(fieldId);
}


// ====== ENTRY POINT ======
function startSearchEverySlot_(ev) {
  replyMessage_(ev.replyToken, {
    type: 'text',
    text: '‡∏≠‡∏¢‡∏≤‡∏Å‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞ üòä\n(‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏ô‡∏ñ‡∏∂‡∏á 24:00)',
    quickReply: {
      items: [
        qrPostback_('‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', 'action=pick_date_search_every_slot&date_mode=today'),
        qrPostback_('‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ', 'action=pick_date_search_every_slot&date_mode=tomorrow'),
        qrDatePicker_('‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ', 'action=set_date_search_every_slot')
      ]
    }
  });
}

// ====== PICK DATE ======
function handlePickDateSearchEverySlot_(ev, data) {
  const dateStr = resolveDateFromMode_(data.date_mode);
  askDurationSearchEverySlot_(ev, dateStr);
}

function handleSetDateSearchEverySlot_(ev, data) {
  const dateStr =
    (data && data.date) ||
    (ev && ev.postback && ev.postback.params && ev.postback.params.date) ||
    '';

  if (!dateStr) {
    replyMessage_(ev.replyToken, { type: 'text', text: '‡∏≠‡πà‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ üôè' });
    return;
  }
  askDurationSearchEverySlot_(ev, dateStr);
}


function askDurationSearchEverySlot_(ev, dateStr) {
  replyMessage_(ev.replyToken, {
    type: 'text',
    text: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏Ñ‡πà‡∏∞ üíö\n‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏µ‡πà‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Ñ‡∏∞',
    quickReply: {
      items: [
        qrPostback_('1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á', `action=pick_duration_search_every_slot&date=${dateStr}&duration=60`),
        qrPostback_('2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á', `action=pick_duration_search_every_slot&date=${dateStr}&duration=120`)
        
      ]
    }
  });
}

// ====== PICK DURATION & SEARCH ======
function handlePickDurationSearchEverySlot_(ev, data) {
  const dateStr = data.date;
  const durationMin = Number(data.duration);

  // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏á
  replyMessage_(ev.replyToken, {
    type: 'text',
    text: '‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å‡∏™‡∏ô‡∏≤‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡πä‡∏ö‡∏ô‡∏∞‡∏Ñ‡∏∞ üòä'
  });

  const resultByField = {};
  const fieldIds = [1, 2, 3, 4, 5, 6];

  fieldIds.forEach(fid => {
    resultByField[fid] = searchEverySlotForField_(
      fid,
      dateStr,
      durationMin
    );
  });

  const flex = buildSearchEverySlotCarousel_(dateStr, durationMin, resultByField);
  pushMessage_(ev.source.userId, flex);
}
function getMatchdayBookings_(fieldId, dateStr) {
  // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ matchday helpers ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà checkAvailability_ ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà
  if (typeof mapFieldNoToCourtId_ !== 'function' ||
      typeof fetchMatchdayMatches_ !== 'function' ||
      typeof buildBusyIntervalsFromMatchday_ !== 'function') {
    // ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤ helper ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß" (‡∏Å‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πà‡∏°‡∏ï‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö)
    return [];
  }

  const courtId = mapFieldNoToCourtId_(fieldId);
  if (!courtId) return [];

  let matches = [];
  try {
    matches = fetchMatchdayMatches_(dateStr, courtId);
  } catch (e) {
    return [];
  }

  const busy = buildBusyIntervalsFromMatchday_(matches) || [];
  // busy: [{start: Date, end: Date, ...}]  -> ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô
  return busy.map(b => ({
    start: b.start.getHours() * 60 + b.start.getMinutes(),
    end:   b.end.getHours() * 60 + b.end.getMinutes()
  }));
}

// ====== AVAILABILITY BRIDGE (‡πÉ‡∏ä‡πâ engine ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÇ‡∏ü‡∏•‡∏à‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á) ======
function isSlotFreeByCheckAvailability_(dateStr, fieldId, startMin, durationMin) {
  if (typeof checkAvailability_ !== 'function') return false; // ‡∏Å‡∏±‡∏ô‡∏û‡∏±‡∏á
  const startStr = minuteToTime_(startMin);
  const endStr = minuteToTime_(startMin + durationMin);
  const res = checkAvailability_(dateStr, Number(fieldId), startStr, endStr);
  return !!(res && res.available === true);
}



// ====== SEARCH ENGINE (STEP 60 MIN) ======
function searchEverySlotForField_(fieldId, dateStr, durationMin) {
  const searchStartMin = getSearchStartMinute_(dateStr);
  const endLimitMin = timeToMinute_(SEARCH_CLOSE_TIME);

  const slots = [];
  for (let start = searchStartMin; start + durationMin <= endLimitMin; start += SEARCH_STEP_MIN) {
    if (isSlotFreeByCheckAvailability_(dateStr, fieldId, start, durationMin)) {
      slots.push({ start, end: start + durationMin });
    }
  }
  return slots;
}



// ====== CHECK TIME AFTER USER CLICK ======
// ====== CHECK TIME AFTER USER CLICK ======
function handleCheckTimeSearchEverySlot_(ev, data) {
  const fieldId = Number(data.field);
  const dateStr = data.date;
  const durationMin = Number(data.duration);
  const startMin = timeToMinute_(data.start);
  const endMin = startMin + durationMin;

  const isFree = isSlotFreeByCheckAvailability_(dateStr, fieldId, startMin, durationMin);

  if (isFree) {
    replyMessage_(ev.replyToken, buildConfirmFreeMessage_(fieldId, dateStr, startMin, endMin, durationMin));
  } else {
    replyMessage_(ev.replyToken, buildNotFreeMessage_(fieldId, dateStr, startMin, endMin));
  }
}



// ====== FLEX BUILDERS ======
function buildSearchEverySlotCarousel_(dateStr, durationMin, resultByField) {
  const bubbles = [];

  Object.keys(resultByField).forEach(fid => {
    const slots = resultByField[fid];

    const contents = slots.length
      ? slots.map(s => ({
        type: 'text',
        text: `${minuteToTime_(s.start)} - ${minuteToTime_(s.end)}`,
        size: 'lg',
        weight: 'bold',
        margin: 'md',
        color: '#1DB446',
        action: {
          type: 'postback',
          data: `action=check_time_search_every_slot&field=${fid}&date=${dateStr}&start=${minuteToTime_(s.start)}&duration=${durationMin}`
        }
      }))

      : [{
          type: 'text',
          text: '‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ üò¢',
          color: '#999999'
        }];

    bubbles.push({
      type: 'bubble',
      body: {
        type: 'box',
        layout: 'vertical',
        contents: [
          { type: 'text', text: `‡∏™‡∏ô‡∏≤‡∏° #${fid}`, weight: 'bold', size: 'lg' },
          {
            type: 'text',
            text: `‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ${getFieldType_(fid)}`,
            size: 'sm',
            color: '#666666'
          },
          { type: 'text', text: `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr}` },
          { type: 'text', text: `‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ ${durationMin / 60} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á` },
          { type: 'separator', margin: 'md' },
          ...contents
        ]
      },
      footer: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'button',
            action: {
              type: 'postback',
              label: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà',
              data: 'action=restart_search_every_slot'
            }
          }
        ]
      }
    });
  });

  return {
    type: 'flex',
    altText: '‡∏Ñ‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á',
    contents: {
      type: 'carousel',
      contents: bubbles
    }
  };
}

// ====== CONFIRM / NOT FREE MESSAGE ======
function buildConfirmFreeMessage_(fieldId, dateStr, startMin, endMin, durationMin) {
  const timeFrom = minuteToTime_(startMin);
  const timeTo   = minuteToTime_(endMin);
  const durationH = (durationMin / 60);

  return {
    type: "flex",
    altText: "‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏à‡∏≠‡∏á",
    contents: {
      type: "bubble",
      body: {
        type: "box",
        layout: "vertical",
        spacing: "md",
        contents: [
          {
            type: "text",
            text: "‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏à‡∏≠‡∏á ‚úÖ",
            weight: "bold",
            size: "lg",
            wrap: true
          },
          {
            type: "box",
            layout: "vertical",
            spacing: "sm",
            contents: [
              row_("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", dateStr),
              row_("‡∏™‡∏ô‡∏≤‡∏°", "‡∏™‡∏ô‡∏≤‡∏° #" + fieldId),
              row_("‡πÄ‡∏ß‡∏•‡∏≤", timeFrom + " - " + timeTo),
              row_("‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤", durationH + " ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á")
            ]
          }
        ]
      },
      footer: {
        type: "box",
        layout: "vertical",
        spacing: "sm",
        contents: [
          {
            type: "button",
            style: "primary",
            action: {
              type: "uri",
              label: "‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á",
              uri: `tel:${ADMIN_PHONE}`
            }
          },
          {
            type: "button",
            style: "secondary",
            action: {
              type: "postback",
              label: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà",
              data: "action=restart_search_every_slot"
            }
          }
        ]
      }
    }
  };
}



function buildNotFreeMessage_(fieldId, dateStr, startMin, endMin) {
  const requestedTime = `${minuteToTime_(startMin)} - ${minuteToTime_(endMin)}`;

  return {
    type: "flex",
    altText: "‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß",
    contents: {
      type: "bubble",
      body: {
        type: "box",
        layout: "vertical",
        spacing: "md",
        contents: [
          {
            type: "text",
            text: "‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß ‚ùå",
            weight: "bold",
            size: "lg",
            color: "#D32F2F"
          },
          {
            type: "box",
            layout: "vertical",
            spacing: "sm",
            contents: [
              row_("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", dateStr),
              row_("‡∏™‡∏ô‡∏≤‡∏°", "‡∏™‡∏ô‡∏≤‡∏° #" + fieldId),
              row_("‡πÄ‡∏ß‡∏•‡∏≤", requestedTime)
            ]
          }
        ]
      },
      footer: {
        type: "box",
        layout: "vertical",
        contents: [
          {
            type: "button",
            style: "secondary",
            action: {
              type: "postback",
              label: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà",
              data: "action=restart_search_every_slot"
            }
          }
        ]
      }
    }
  };
}



// ====== UTILS ======
function resolveDateFromMode_(mode) {
  const d = new Date();
  if (mode === 'tomorrow') d.setDate(d.getDate() + 1);
  return Utilities.formatDate(d, TZ, 'yyyy-MM-dd');
}

function getSearchStartMinute_(dateStr) {
  const now = new Date();
  const todayStr = Utilities.formatDate(now, TZ, 'yyyy-MM-dd');
  if (dateStr !== todayStr) return timeToMinute_(SEARCH_OPEN_TIME);

  const openMin = timeToMinute_(SEARCH_OPEN_TIME);

  const h = now.getHours();
  const m = now.getMinutes();
  const roundedUp = (m === 0) ? (h * 60) : ((h + 1) * 60);

  return Math.max(openMin, roundedUp);
}


function timeToMinute_(t) {
  const [h, m] = t.split(':').map(Number);
  return h * 60 + m;
}

function minuteToTime_(min) {
  const h = Math.floor(min / 60);
  const m = min % 60;
  return `${('0' + h).slice(-2)}:${('0' + m).slice(-2)}`;
}

function isOverlapWithBookings_(start, end, bookings) {
  return bookings.some(b => !(end <= b.start || start >= b.end));
}

function qrPostback_(label, data) {
  return {
    type: 'action',
    action: { type: 'postback', label, data }
  };
}

function qrDatePicker_(label, data) {
  return {
    type: 'action',
    action: { type: 'datetimepicker', label, data, mode: 'date' }
  };
}

