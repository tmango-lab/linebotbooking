import{c as D,r as a,s as k,j as e}from"./index-CdUUaiY8.js";import{C,R as M}from"./receipt-CtvDfts5.js";import{R as L}from"./refresh-cw-WsqWbFVX.js";import{T as $}from"./tag-QzuSGgCA.js";const F=[["path",{d:"M16 17h6v-6",key:"t6n2it"}],["path",{d:"m22 17-8.5-8.5-5 5L2 7",key:"x473p"}]],G=D("trending-down",F);const U=[["path",{d:"M16 7h6v6",key:"box55l"}],["path",{d:"m22 7-8.5 8.5-5-5L2 17",key:"1t1m79"}]],I=D("trending-up",U);function O(){const[c,m]=a.useState(!1),[o,S]=a.useState({totalRevenue:0,confirmedBookings:0,cancelledBookings:0,discountsGiven:0,couponsUsed:0,couponsBurned:0}),[n,R]=a.useState("today"),[r,_]=a.useState(""),[d,B]=a.useState(""),g=t=>t.toISOString().split("T")[0];a.useEffect(()=>{h()},[n,r,d]);const h=async()=>{m(!0);try{let t=new Date,i=new Date;if(n!=="today"){if(n==="week"){const s=t.getDay(),l=t.getDate()-s+(s===0?-6:1);t.setDate(l),i.setDate(t.getDate()+6)}else if(n==="month")t=new Date(t.getFullYear(),t.getMonth(),1),i=new Date(t.getFullYear(),t.getMonth()+1,0);else if(n==="custom"){if(!r||!d){m(!1);return}t=new Date(r),i=new Date(d)}}const x=g(t),u=g(i);console.log(`Fetching report for ${x} to ${u}`);const{data:T,error:p}=await k.from("bookings").select("*").gte("date",x).lte("date",u);if(p)throw p;const{data:f,error:j}=await k.from("user_coupons").select("*").in("status",["used","burned"]).gte("updated_at",`${x}T00:00:00`).lte("updated_at",`${u}T23:59:59`);if(j)throw j;let b=0,v=0,N=0,w=0,y=0;(T||[]).forEach(s=>{if(s.status==="confirmed"){if(v++,b+=s.price_total_thb||0,s.admin_note&&s.admin_note.includes("(-")){const l=s.admin_note.match(/\(-(\d+)\)/);l&&(w+=parseInt(l[1],10))}}else s.status==="cancelled"&&N++});const E=(f||[]).filter(s=>s.status==="burned").length;y=(f||[]).filter(s=>s.status==="used").length,S({totalRevenue:b,confirmedBookings:v,cancelledBookings:N,discountsGiven:w,couponsUsed:y,couponsBurned:E})}catch(t){console.error("Error fetching report:",t)}finally{m(!1)}};return e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(C,{className:"h-6 w-6"})," Financial Report"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:n,onChange:t=>R(t.target.value),className:"bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-indigo-500",children:[e.jsx("option",{value:"today",children:"Today"}),e.jsx("option",{value:"week",children:"This Week"}),e.jsx("option",{value:"month",children:"This Month"}),e.jsx("option",{value:"custom",children:"Custom Range"})]}),n==="custom"&&e.jsxs("div",{className:"flex items-center gap-2 bg-white p-1 rounded border border-gray-200",children:[e.jsx("input",{type:"date",value:r,onChange:t=>_(t.target.value),className:"text-sm border-none focus:ring-0 p-1"}),e.jsx("span",{className:"text-gray-400",children:"-"}),e.jsx("input",{type:"date",value:d,onChange:t=>B(t.target.value),className:"text-sm border-none focus:ring-0 p-1"})]}),e.jsx("button",{onClick:h,className:"ml-2 p-2 bg-indigo-50 text-indigo-600 rounded-md hover:bg-indigo-100",children:e.jsx(L,{className:`h-5 w-5 ${c?"animate-spin":""}`})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-500",children:"Net Revenue"}),e.jsxs("h3",{className:"text-2xl font-bold text-gray-900 mt-2",children:["฿",o.totalRevenue.toLocaleString()]}),e.jsxs("p",{className:"text-xs text-green-600 flex items-center mt-1",children:[e.jsx(M,{className:"h-3 w-3 mr-1"})," ",o.confirmedBookings," Bookings"]})]}),e.jsx("div",{className:"p-3 bg-green-50 rounded-lg",children:e.jsx(I,{className:"h-6 w-6 text-green-600"})})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-500",children:"Discounts Given"}),e.jsxs("h3",{className:"text-2xl font-bold text-red-600 mt-2",children:["-฿",o.discountsGiven.toLocaleString()]}),e.jsx("p",{className:"text-xs text-red-600 flex items-center mt-1",children:"From Coupons & Promos"})]}),e.jsx("div",{className:"p-3 bg-red-50 rounded-lg",children:e.jsx($,{className:"h-6 w-6 text-red-500"})})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-500",children:"Coupons Used"}),e.jsx("h3",{className:"text-2xl font-bold text-indigo-600 mt-2",children:o.couponsUsed}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Successfully redeemed"})]}),e.jsx("div",{className:"p-3 bg-indigo-50 rounded-lg",children:e.jsx(P,{className:"h-6 w-6 text-indigo-600"})})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-500",children:"Coupons Burned"}),e.jsx("h3",{className:"text-2xl font-bold text-orange-600 mt-2",children:o.couponsBurned}),e.jsx("p",{className:"text-xs text-orange-500 mt-1",children:"Anti-Gaming / Expired"})]}),e.jsx("div",{className:"p-3 bg-orange-50 rounded-lg",children:e.jsx(G,{className:"h-6 w-6 text-orange-600"})})]})]}),e.jsx("div",{className:"bg-blue-50 border-l-4 border-blue-400 p-4 mb-8",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(C,{className:"h-5 w-5 text-blue-400"})}),e.jsx("div",{className:"ml-3",children:e.jsxs("p",{className:"text-sm text-blue-700",children:[e.jsx("strong",{children:"Note:"})," Discounts are estimated based on 'admin_note' parsing in existing booking data. Burned coupons are counted based on 'updated_at' date."]})})]})})]})}function P({className:c}){return e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:c,children:[e.jsx("path",{d:"M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"}),e.jsx("path",{d:"M13 5v2"}),e.jsx("path",{d:"M13 17v2"}),e.jsx("path",{d:"M13 11v2"})]})}export{O as default};
